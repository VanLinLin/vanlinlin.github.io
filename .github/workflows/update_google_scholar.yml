name: Update Google Scholar Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  update-scholar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Fetch and Process Google Scholar Stats
        env:
          SERPAPI_API_KEY: ${{ secrets.SERPAPI_API_KEY }}
          GOOGLE_SCHOLAR_ID: ${{ secrets.GOOGLE_SCHOLAR_ID }}
        run: |
          echo "ğŸš€ Fetching Google Scholar data using curl..."
          
          # 1. å»ºç«‹ç›®æ¨™è³‡æ–™å¤¾
          mkdir -p google_scholar_crawler/results
          
          # 2. ç›´æ¥ä½¿ç”¨ curl æŠ“å–åŸå§‹çš„å­¸è€…è³‡æ–™ï¼Œä¸¦å­˜æˆ gs_data.json
          curl --location --silent "https://serpapi.com/search.json?engine=google_scholar_author&author_id=${GOOGLE_SCHOLAR_ID}&api_key=${SERPAPI_API_KEY}" > google_scholar_crawler/results/gs_data.json

          # 3. æª¢æŸ¥æŠ“å–çš„è³‡æ–™æ˜¯å¦æœ‰èª¤
          if grep -q "error_message" google_scholar_crawler/results/gs_data.json; then
            echo "âŒ SERPAPI returned an error:"
            cat google_scholar_crawler/results/gs_data.json
            exit 1
          fi
          echo "âœ… Successfully fetched raw author data."

          # 4. ä½¿ç”¨ jq å¾ gs_data.json ä¸­æå–è¢«å¼•ç”¨æ¬¡æ•¸ (citations)
          CITATIONS=$(jq '.author.cited_by' google_scholar_crawler/results/gs_data.json)
          if [ -z "$CITATIONS" ] || [ "$CITATIONS" == "null" ]; then
            echo "âŒ Could not find citation count in the response."
            exit 1
          fi
          echo "ğŸ“Š Citation count: $CITATIONS"

          # 5. ä½¿ç”¨ jq å»ºç«‹çµ¦ shields.io ä½¿ç”¨çš„ JSON æª”æ¡ˆ
          jq -n --arg citations "$CITATIONS" '{schemaVersion: 1, label: "citations", message: $citations}' > google_scholar_crawler/results/gs_data_shieldsio.json
          echo "âœ… Successfully created shields.io JSON file."

      - name: Check output
        run: |
          ls -al google_scholar_crawler/results
          echo "--- gs_data.json content ---"
          cat google_scholar_crawler/results/gs_data.json | head -n 10
          echo "--- gs_data_shieldsio.json content ---"
          cat google_scholar_crawler/results/gs_data_shieldsio.json

      - name: Commit and push updated JSON
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          # ä½¿ç”¨ -f å¼·åˆ¶åŠ å…¥è¢« .gitignore å¿½ç•¥çš„ json æª”æ¡ˆ
          git add -f google_scholar_crawler/results/*.json
          # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šå‹•ï¼Œæ²’æœ‰è®Šå‹•å°±ä¸æäº¤
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ”„ Update Google Scholar stats (via curl)"
            git push
          else
            echo "âœ… No changes in Google Scholar stats. Nothing to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
