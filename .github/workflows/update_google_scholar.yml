name: Update Google Scholar Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  update-scholar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Set up Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r google_scholar_crawler/requirements.txt
          pip install scholarly

# ==================== è«‹åŠ å…¥é€™å€‹æ–°æ­¥é©Ÿ ====================
      - name: Test SERPAPI API Key
        run: |
          echo "ğŸ§ª Testing SERPAPI API Key..."
          curl "https://serpapi.com/search.json?engine=google&q=coffee&api_key=${{ secrets.SERPAPI_API_KEY }}" > serpapi_test_output.json
          
          # æª¢æŸ¥å›å‚³çš„ JSON ä¸­æ˜¯å¦åŒ…å« "error" é€™å€‹è©
          if grep -q "error" serpapi_test_output.json; then
            echo "âŒ SERPAPI API Key æ¸¬è©¦å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„é‡‘é‘°æˆ–å¸³æˆ¶ç‹€æ…‹ã€‚"
            cat serpapi_test_output.json
            exit 1
          else
            echo "âœ… SERPAPI API Key æ¸¬è©¦æˆåŠŸï¼"
            # ç‚ºäº†å®‰å…¨ï¼Œåªé¡¯ç¤ºéƒ¨åˆ†ç„¡é—œç·Šè¦çš„å›å‚³å…§å®¹
            cat serpapi_test_output.json | head -n 10
          fi


      - name: Run main.py to fetch Google Scholar stats
        # å¢åŠ è¶…æ™‚è¨­å®šï¼Œ10åˆ†é˜æ²’è·‘å®Œå°±è‡ªå‹•åˆ¤å®šå¤±æ•—ï¼Œé¿å…ç„¡é™ç©ºç­‰
        timeout-minutes: 10
        env:
          GOOGLE_SCHOLAR_ID: ${{ secrets.GOOGLE_SCHOLAR_ID }}
          SERPAPI_API_KEY: ${{ secrets.SERPAPI_API_KEY }}
        run: |
          echo "ğŸš€ Starting scholar crawler"

          # ==================== DEBUGGING STEP ====================
          # æª¢æŸ¥ Secrets æ˜¯å¦æœ‰è¢«æ­£ç¢ºè¼‰å…¥
          if [ -z "$GOOGLE_SCHOLAR_ID" ]; then
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° GOOGLE_SCHOLAR_ID é€™å€‹ Secretï¼"
            exit 1
          else
            echo "âœ… GOOGLE_SCHOLAR_ID å·²è¨­å®šã€‚"
          fi

          if [ -z "$SERPAPI_API_KEY" ]; then
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° SERPAPI_API_KEY é€™å€‹ Secretï¼è«‹æª¢æŸ¥ repo -> Settings -> Secrets and variables -> Actions"
            exit 1
          else
            # ç‚ºäº†å®‰å…¨ï¼Œåªå°å‡ºé‡‘é‘°çš„å‰5å€‹å­—å…ƒï¼Œç¢ºèªå®ƒæœ‰è¢«è¼‰å…¥
            echo "âœ… SERPAPI_API_KEY å·²è¨­å®š (é‡‘é‘°é–‹é ­ç‚º: ${SERPAPI_API_KEY:0:5}...)"
          fi
          # =========================================================

          export SCHOLARY_BACKEND=serpapi
          # scholarly æœƒè‡ªå‹•å¾ç’°å¢ƒè®Šæ•¸è®€å– SERPAPI_API_KEY
          python google_scholar_crawler/main.py

      - name: Check output
        run: |
          ls -al google_scholar_crawler/results || echo "ğŸ“‚ Folder not found"
          cat google_scholar_crawler/results/gs_data.json || echo "âŒ gs_data.json missing"
          cat google_scholar_crawler/results/gs_data_shieldsio.json || echo "âŒ gs_data_shieldsio.json missing"

      - name: Commit and push updated JSON
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git add google_scholar_crawler/results/*.json
          # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šå‹•
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ”„ Update Google Scholar stats"
            git push
          else
            echo "No changes to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
