name: Update Google Scholar Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  update-scholar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Fetch and Process Google Scholar Stats
        env:
          SERPAPI_API_KEY: ${{ secrets.SERPAPI_API_KEY }}
          GOOGLE_SCHOLAR_ID: ${{ secrets.GOOGLE_SCHOLAR_ID }}
        run: |
          echo "ðŸš€ Fetching Google Scholar data using curl..."
          
          # 1. å»ºç«‹ç›®æ¨™è³‡æ–™å¤¾
          mkdir -p google_scholar_crawler/results
          
          # 2. === æ ¸å¿ƒä¿®æ­£ ===
          # åœ¨ curl ç¶²å€ä¸­åŠ å…¥ &view_op=list_works&sortby=pubdate ä¾†ç¢ºä¿èƒ½æŠ“åˆ°å¼•ç”¨æ¬¡æ•¸è¡¨æ ¼
          curl --location --silent "https://serpapi.com/search.json?engine=google_scholar_author&author_id=${GOOGLE_SCHOLAR_ID}&view_op=list_works&sortby=pubdate&api_key=${SERPAPI_API_KEY}" > google_scholar_crawler/results/gs_data.json

          echo "ðŸ” Dumping received JSON content for verification:"
          cat google_scholar_crawler/results/gs_data.json | head -n 30
          
          # 3. æª¢æŸ¥æŠ“å–çš„è³‡æ–™æ˜¯å¦æœ‰èª¤
          if grep -q "error_message" google_scholar_crawler/results/gs_data.json; then
            echo "âŒ SERPAPI returned an error."
            exit 1
          fi
          echo "âœ… Successfully fetched raw author data."

          # 4. === æ ¸å¿ƒä¿®æ­£ ===
          # å¾ž gs_data.json ä¸­æå–è¢«å¼•ç”¨æ¬¡æ•¸ï¼Œä½¿ç”¨æœ€å¤–å±¤çš„ "cited_by" ç‰©ä»¶
          CITATIONS=$(jq '.cited_by.table[0].citations.all' google_scholar_crawler/results/gs_data.json)
          
          if [ -z "$CITATIONS" ] || [ "$CITATIONS" == "null" ]; then
            echo "âŒ Could not find citation count. Please check the JSON dump above."
            exit 1
          fi
          echo "ðŸ“Š Citation count: $CITATIONS"

          # 5. ä½¿ç”¨ jq å»ºç«‹çµ¦ shields.io ä½¿ç”¨çš„ JSON æª”æ¡ˆ
          jq -n --arg citations "$CITATIONS" '{schemaVersion: 1, label: "citations", message: $citations}' > google_scholar_crawler/results/gs_data_shieldsio.json
          echo "âœ… Successfully created shields.io JSON file."

      - name: Check output
        run: |
          ls -al google_scholar_crawler/results

      - name: Commit and push updated JSON
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git add -f google_scholar_crawler/results/*.json
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ”„ Update Google Scholar stats"
            git push
          else
            echo "âœ… No changes in Google Scholar stats. Nothing to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
