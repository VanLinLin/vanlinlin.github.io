<style>
    /* æ¨£å¼ç¢¼ç¶­æŒä¸è®Š */
    html, body {
        margin: 0; padding: 0; width: 100%; height: 100%;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #FFF;
        display: flex; flex-direction: column; align-items: center;
    }
    h2 {
        font-size: 1.2em; color: #555; font-weight: bold;
        padding: 10px 0; margin: 0; flex-shrink: 0;
    }
    #globeViz {
        width: 100%; height: 100%; flex-grow: 1; cursor: grab;
    }
</style>

<h2>ğŸŒ Global Collaborations</h2>
<div id="globeViz"></div>

<script src="https://unpkg.com/globe.gl"></script>
<script>
window.addEventListener('load', function() {
    const globeContainer = document.getElementById('globeViz');

    // =================================================================
    // 1. è¨­å®šæ‚¨æœªä¾†çš„å¾Œç«¯ API ç¶²å€
    // =================================================================
    // ç•¶æ‚¨å»ºç«‹å¥½å¾Œç«¯å¾Œï¼Œè«‹å°‡é€™å€‹ç¶²å€æ›æˆæ‚¨è‡ªå·±çš„
    const BACKEND_API_URL = 'https://your-backend-api.vercel.app/api/locations'; // <--- æ›¿æ›æˆæ‚¨çš„ API

    // =================================================================
    // 2. åˆå§‹åŒ–åœ°çƒå„€
    // =================================================================
    const globe = Globe()(globeContainer)
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
        .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
        .backgroundColor('rgba(255,255,255,0)')
        .showGraticules(true);

    globe.pointOfView({ lat: 23.5, lng: 121, altitude: 2.0 });
    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.4;
    globe.controls().enableZoom = false;

    // =================================================================
    // 3. å®šç¾©é»çš„æ¨£å¼
    // =================================================================
    globe.pointAltitude(0.01) // è®“é»ç¨å¾®æµ®èµ·ä¾†
         .pointColor('color')
         .pointRadius('radius');

    // =================================================================
    // 4. å–å¾—è¨ªå®¢æ•¸æ“šä¸¦ç¹ªè£½
    // =================================================================
    async function fetchAndDrawLocations() {
        try {
            // å¾æ‚¨çš„å¾Œç«¯ç²å–æ‰€æœ‰éå»çš„è¨ªå®¢åº§æ¨™
            // fetch æœƒè‡ªå‹•é€å‡ºæ‚¨ç•¶å‰çš„ IPï¼Œå¾Œç«¯å¯ä»¥æ¥æ”¶ä¸¦è™•ç†
            const response = await fetch(BACKEND_API_URL);
            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }
            const data = await response.json();

            // data æ‡‰è©²åŒ…å«:
            // {
            //   "pastLocations": [ { "lat": ..., "lng": ... }, ... ],
            //   "currentLocation": { "lat": ..., "lng": ... }
            // }

            // è™•ç†éå»çš„è¨ªå®¢ (éœæ…‹é»)
            const pastPoints = data.pastLocations.map(loc => ({
                ...loc,
                radius: 0.25,
                color: 'rgba(255, 255, 255, 0.7)' // éœæ…‹é»ï¼šç™½è‰²
            }));

            // è™•ç†ç•¶ä¸‹çš„è¨ªå®¢ (å‹•æ…‹é»)
            const currentPoint = {
                ...data.currentLocation,
                radius: 0.4, // å‹•æ…‹é»æ¯”è¼ƒå¤§
                color: '#ffcc00' // å‹•æ…‹é»ï¼šäº®é»ƒè‰²
            };

            // å°‡æ‰€æœ‰é»åˆä½µä¸¦æ›´æ–°åˆ°åœ°çƒä¸Š
            const allPoints = [...pastPoints, currentPoint];
            globe.pointsData(allPoints);

        } catch (error) {
            console.error("ç„¡æ³•ç²å–è¨ªå®¢ä½ç½®:", error);
            // å¦‚æœ API å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­çš„é»
            globe.pointsData([
                { lat: 22.9987, lng: 120.2195, radius: 0.25, color: 'rgba(255, 255, 255, 0.7)'},
                { lat: 24.1231, lng: 120.6740, radius: 0.25, color: 'rgba(255, 255, 255, 0.7)'},
                { lat: 55.9533, lng: -3.1883,  radius: 0.25, color: 'rgba(255, 255, 255, 0.7)'}
            ]);
        }
    }

    fetchAndDrawLocations();

    // è®“å‹•æ…‹çš„é»æœ‰ "å‘¼å¸" çš„å‹•ç•«æ•ˆæœ
    setInterval(() => {
        const points = globe.pointsData();
        const current = points[points.length - 1]; // å‡è¨­æœ€å¾Œä¸€å€‹é»æ˜¯ç•¶å‰è¨ªå®¢
        if (current) {
            current.radius = 0.4 + Math.sin(Date.now() / 300) * 0.15;
            globe.pointsData(points);
        }
    }, 60);

});
</script>